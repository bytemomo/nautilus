name: "Data Corruption Simulation"
description: "Corrupt packet data to test client error handling and data validation"

proxy:
    listen: ":8080"
    target: "server.example.com:80"
    protocol: tcp
    max_connections: 1000
    connection_timeout: "30s"
    buffer_size: 32768
    enable_logging: true

rules:
    # Random byte corruption (light)
    - name: "Light Corruption - 1 byte per packet"
      enabled: false
      priority: 100
      match:
          direction: both
          probability: 0.1  # Corrupt 10% of packets
      action:
          type: modify
          operation: corrupt_bytes
          positions: [0]  # Corrupt first byte

    # Moderate corruption - multiple bytes
    - name: "Moderate Corruption - Multiple bytes"
      enabled: true
      priority: 100
      match:
          direction: server_to_client
          probability: 0.05  # Corrupt 5% of packets
      action:
          type: modify
          operation: corrupt_bytes
          positions: [10, 50, 100, 200]  # Corrupt bytes at these positions

    # Corrupt HTTP headers
    - name: "Corrupt HTTP Headers"
      enabled: false
      priority: 110
      match:
          direction: server_to_client
          content_starts_with: "HTTP/"
          probability: 0.15
      action:
          type: modify
          operation: corrupt_bytes
          positions: [5, 10, 15]  # Corrupt status line

    # Corrupt JSON responses
    - name: "Corrupt JSON Data"
      enabled: false
      priority: 110
      match:
          direction: server_to_client
          content_contains: "application/json"
      action:
          type: modify
          operation: corrupt_bytes
          positions: [50, 100, 150, 200]

    # Truncate packets (data loss)
    - name: "Truncate Large Packets"
      enabled: false
      priority: 100
      match:
          direction: both
          size_gt: 1024
          probability: 0.1
      action:
          type: modify
          operation: truncate
          truncate_at: 512  # Cut packet in half

    # Append garbage data
    - name: "Append Garbage Data"
      enabled: false
      priority: 100
      match:
          direction: server_to_client
          probability: 0.05
      action:
          type: modify
          operation: append
          bytes: [0xFF, 0xFF, 0xAA, 0xAA, 0x00, 0x00]

    # Replace specific strings (protocol violation)
    - name: "Replace HTTP Version"
      enabled: false
      priority: 110
      match:
          direction: server_to_client
          content_starts_with: "HTTP/"
          probability: 0.2
      action:
          type: modify
          operation: replace
          pattern: "HTTP/1.1"
          replacement: "HTTP/9.9"

    # Replace status codes
    - name: "Replace Success with Error"
      enabled: false
      priority: 110
      match:
          direction: server_to_client
          content_contains: "200 OK"
      action:
          type: modify
          operation: replace
          pattern: "200 OK"
          replacement: "500 Internal Server Error"

    # Corrupt Content-Length header
    - name: "Corrupt Content-Length"
      enabled: false
      priority: 110
      match:
          direction: server_to_client
          content_contains: "Content-Length:"
          probability: 0.1
      action:
          type: modify
          operation: replace
          pattern: "Content-Length: "
          replacement: "Content-Length: 99999999"

    # Corrupt checksums in binary protocols
    - name: "Corrupt Binary Protocol Headers"
      enabled: false
      priority: 100
      match:
          direction: both
          size_gt: 100
          probability: 0.05
      action:
          type: modify
          operation: corrupt_bytes
          positions: [0, 1, 2, 3]  # Corrupt first 4 bytes (often header)

    # Heavy corruption - many bytes
    - name: "Heavy Corruption - 10 bytes"
      enabled: false
      priority: 100
      match:
          direction: both
          probability: 0.02  # Corrupt 2% of packets heavily
      action:
          type: modify
          operation: corrupt_bytes
          positions: [10, 20, 30, 40, 50, 60, 70, 80, 90, 100]

    # Corrupt only large responses
    - name: "Corrupt Large Responses"
      enabled: false
      priority: 110
      match:
          direction: server_to_client
          size_gt: 8192  # Packets larger than 8KB
          probability: 0.15
      action:
          type: modify
          operation: corrupt_bytes
          positions: [100, 500, 1000, 2000, 4000]

    # Chain: Log then corrupt
    - name: "Log and Corrupt"
      enabled: false
      priority: 90
      match:
          direction: both
          probability: 0.05
      action:
          type: chain
          actions:
              - type: log
                level: info
                message: "Corrupting packet"
                dump_payload: true
              - type: modify
                operation: corrupt_bytes
                positions: [10, 50, 100]

    # Corrupt after connection has been active for a while
    - name: "Delayed Corruption"
      enabled: false
      priority: 80
      match:
          direction: both
          connection_age: ">30s"
          probability: 0.1
      action:
          type: modify
          operation: corrupt_bytes
          positions: [25, 75, 125]

recording:
    enabled: true
    output: "captures/corruption_test.json"
    format: json
    include_payload: true  # Important to see corrupted data
    max_file_size: "100MB"
    flush_interval: "5s"
