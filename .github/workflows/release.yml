name: Release

on:
    push:
        tags:
            - "v*.*.*"
    workflow_dispatch:

permissions:
    contents: write

jobs:
    build:
        name: Build and Release
        runs-on: ubuntu-latest
        env:
            GOOS: linux
            GOARCH: amd64
        steps:
            - uses: actions/checkout@v5

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.25.1"

            - name: Install build dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y protobuf-compiler clang libbpf-dev libelf-dev
                  sudo snap install just --classic

            - name: Configure kernel headers include path for eBPF
              run: echo "C_INCLUDE_PATH=/usr/include/$(gcc -dumpmachine)" >> $GITHUB_ENV

            - name: Install protobuf generators
              run: |
                  go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
                  go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
                  echo "$HOME/go/bin" >> $GITHUB_PATH

            - name: Build binaries
              run: |
                  just kraken-build

            - name: Archive release files
              working-directory: dist
              run: |
                  zip kraken-${{ env.GOOS }}-${{ env.GOARCH }}.zip kraken
                  zip modules-src.zip -r ../modules

            - name: Create GitHub release
              uses: softprops/action-gh-release@v2
              if: github.ref_type == 'tag'
              with:
                  files: dist/*.zip

    public_release:
        runs-on: ubuntu-latest
        needs: build
        steps:
            - uses: actions/checkout@v5
              with:
                  fetch-depth: 0

            - name: Push to public repository
              env:
                  GIT_AUTHOR_NAME: github-actions[bot]
                  GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
                  GIT_COMMITTER_NAME: github-actions[bot]
                  GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
                  PUBLIC_REPO_TOKEN: ${{ secrets.NAUTILUS_PUBLIC_RELEASE }}
              run: |
                  TAG_NAME="${GITHUB_REF#refs/tags/}"
                  COMMIT_MSG="Release ${TAG_NAME}"

                  # Add public remote with token
                  git remote add public https://x-access-token:${PUBLIC_REPO_TOKEN}@github.com/bytemomo/nautilus.git

                  # Fetch public repo's master (if exists)
                  git fetch public master || true

                  # Create release branch from public/master or as orphan if first release
                  if git rev-parse public/master >/dev/null 2>&1; then
                      git checkout -b release public/master
                  else
                      git checkout --orphan release
                  fi

                  # Remove all tracked files, copy current state
                  git rm -rf . || true
                  git checkout ${{ github.sha }} -- .
                  
                  # Remove .github folder
                  rm -rf .github
                  
                  # Commit and push
                  git add -A
                  git commit -m "${COMMIT_MSG}"
                  git tag "${TAG_NAME}"
                  git push public release:master
                  git push public "${TAG_NAME}"
