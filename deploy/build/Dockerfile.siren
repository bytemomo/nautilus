FROM golang:1.25.1-alpine AS builder

RUN apk add --no-cache clang bash linux-headers libbpf-dev

WORKDIR /app
COPY go.work go.work.sum ./
COPY kraken/go.mod kraken/go.sum ./kraken/
COPY siren/go.mod siren/go.sum ./siren/
COPY trident/go.mod trident/go.sum ./trident/
RUN go mod download
COPY . .

RUN cd ./siren/ebpf && go generate

RUN CGO_ENABLED=0 GOOS=linux go build -o /siren ./siren/cmd/siren

# Final stage
FROM alpine:latest
COPY --from=builder /siren /siren
ENTRYPOINT [ "/siren" ]
