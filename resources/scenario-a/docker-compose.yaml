# Scenario A: MQTT Threat Model for Remote Telemetry & Control
# 
# This environment mirrors the MQTT control plane described in Section 9.3 of the thesis:
# - MQTT broker with TLS in the industrial DMZ
# - Publisher containers emulating PLCs/RTUs (field devices)
# - Subscriber containers emulating SCADA/HMI systems
# - Optional bridge container for DMZ-enterprise flow testing
#
# Networks:
#   ot_net    - OT network (field devices, publishers)
#   dmz_net   - Industrial DMZ (broker, bridge, kraken)
#   it_net    - Enterprise/IT network (for bridge lateral movement testing)

services:
  # =============================================================================
  # Bootstrap: Generates certificates and password file
  # =============================================================================
  certs:
    image: eclipse-mosquitto:2.0
    container_name: scenario-a-certs
    volumes:
      - ./certs:/certs
      - ./config:/config
      - ./scripts:/scripts
    command: 
      - /bin/sh
      - -c
      - |
        # Install openssl for certificate generation
        apk add --no-cache openssl > /dev/null 2>&1
        
        # Generate certificates
        /bin/sh /scripts/generate-certs.sh
        
        # Generate password file if it doesn't have hashed passwords
        if ! grep -q '$$' /config/passwd 2>/dev/null; then
          echo "Generating hashed password file..."
          rm -f /config/passwd
          mosquitto_passwd -b -c /config/passwd admin admin123
          mosquitto_passwd -b /config/passwd scada scada123
          mosquitto_passwd -b /config/passwd plc plc123
          mosquitto_passwd -b /config/passwd rtu rtu123
          mosquitto_passwd -b /config/passwd operator operator
          mosquitto_passwd -b /config/passwd guest guest
          echo "Password file generated."
        else
          echo "Password file already contains hashed passwords."
        fi
        
        # Fix permissions so mosquitto user (UID 1883) can read files
        chmod 644 /config/passwd /config/acl.conf /config/mosquitto.conf 2>/dev/null || true
        chmod 644 /certs/*.crt 2>/dev/null || true
        chmod 644 /certs/*.key 2>/dev/null || true
    networks:
      - dmz_net

  # =============================================================================
  # MQTT Broker (Mosquitto) - Industrial DMZ
  # Represents the central MQTT broker at level 3.5
  # =============================================================================
  broker:
    image: eclipse-mosquitto:2.0
    container_name: scenario-a-broker
    hostname: mqtt-broker
    depends_on:
      certs:
        condition: service_completed_successfully
    ports:
      - "1883:1883"   # MQTT (plaintext - for testing anonymous access)
      - "8883:8883"   # MQTTS (TLS)
      - "8884:8884"   # MQTTS with client certificates (mTLS)
    volumes:
      - ./config/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - ./config/acl.conf:/mosquitto/config/acl.conf:ro
      - ./config/passwd:/mosquitto/config/passwd:ro
      - ./certs:/mosquitto/certs:ro
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log
    entrypoint: ["/usr/sbin/mosquitto", "-c", "/mosquitto/config/mosquitto.conf"]
    networks:
      dmz_net:
        ipv4_address: 172.20.0.10
      ot_net:
        ipv4_address: 172.21.0.10
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 1883 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s
    restart: unless-stopped

  # =============================================================================
  # PLC/RTU Simulator - Publisher (Field Device)
  # Publishes telemetry data to the broker
  # =============================================================================
  plc-publisher:
    image: eclipse-mosquitto:2.0
    container_name: scenario-a-plc
    hostname: plc-01
    depends_on:
      broker:
        condition: service_healthy
    volumes:
      - ./certs:/certs:ro
      - ./scripts:/scripts:ro
    entrypoint: ["/bin/sh", "/scripts/plc-publisher.sh"]
    environment:
      - MQTT_BROKER=mqtt-broker
      - MQTT_PORT=8883
      - CLIENT_ID=plc-01
      - DEVICE_TYPE=plc
    networks:
      ot_net:
        ipv4_address: 172.21.0.20
    restart: unless-stopped

  # =============================================================================
  # RTU Simulator - Publisher (Field Device)
  # Publishes sensor data to the broker
  # =============================================================================
  rtu-publisher:
    image: eclipse-mosquitto:2.0
    container_name: scenario-a-rtu
    hostname: rtu-01
    depends_on:
      broker:
        condition: service_healthy
    volumes:
      - ./certs:/certs:ro
      - ./scripts:/scripts:ro
    entrypoint: ["/bin/sh", "/scripts/rtu-publisher.sh"]
    environment:
      - MQTT_BROKER=mqtt-broker
      - MQTT_PORT=8883
      - CLIENT_ID=rtu-01
      - DEVICE_TYPE=rtu
    networks:
      ot_net:
        ipv4_address: 172.21.0.21
    restart: unless-stopped

  # =============================================================================
  # SCADA/HMI Simulator - Subscriber (Control Room)
  # Subscribes to telemetry and publishes commands
  # =============================================================================
  scada-subscriber:
    image: eclipse-mosquitto:2.0
    container_name: scenario-a-scada
    hostname: scada-01
    depends_on:
      broker:
        condition: service_healthy
    volumes:
      - ./certs:/certs:ro
      - ./scripts:/scripts:ro
    entrypoint: ["/bin/sh", "/scripts/scada-subscriber.sh"]
    environment:
      - MQTT_BROKER=mqtt-broker
      - MQTT_PORT=8883
      - CLIENT_ID=scada-01
    networks:
      dmz_net:
        ipv4_address: 172.20.0.20
    restart: unless-stopped

  # =============================================================================
  # MQTT Bridge - DMZ to Enterprise (for L-1 lateral movement testing)
  # =============================================================================
  bridge:
    image: eclipse-mosquitto:2.0
    container_name: scenario-a-bridge
    hostname: mqtt-bridge
    depends_on:
      broker:
        condition: service_healthy
    volumes:
      - ./config/bridge.conf:/mosquitto/config/mosquitto.conf:ro
      - ./certs:/mosquitto/certs:ro
    networks:
      dmz_net:
        ipv4_address: 172.20.0.30
      it_net:
        ipv4_address: 172.22.0.30
    profiles:
      - bridge
    restart: unless-stopped

  # =============================================================================
  # Seed Container - Initializes retained messages and topic structure
  # =============================================================================
  seeder:
    image: eclipse-mosquitto:2.0
    container_name: scenario-a-seeder
    depends_on:
      broker:
        condition: service_healthy
    volumes:
      - ./certs:/certs:ro
      - ./scripts:/scripts:ro
    entrypoint: ["/bin/sh", "/scripts/seed-topics.sh"]
    environment:
      - MQTT_BROKER=mqtt-broker
      - MQTT_PORT=1883
    networks:
      dmz_net:
        ipv4_address: 172.20.0.99
    restart: "no"

networks:
  # OT Network - Field devices (Level 0/1/2)
  ot_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/24
          gateway: 172.21.0.1

  # DMZ Network - Industrial DMZ (Level 3.5)
  dmz_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
          gateway: 172.20.0.1

  # IT Network - Enterprise (Level 4/5) - for bridge testing
  it_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.22.0.0/24
          gateway: 172.22.0.1

volumes:
  mosquitto_data:
  mosquitto_log:
