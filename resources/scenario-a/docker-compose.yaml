# Scenario A: MQTT Threat Model for Remote Telemetry & Control
#
# This environment mirrors the MQTT control plane described in the docs:
# - MQTT broker with TLS in the industrial DMZ
# - Publisher containers emulating PLCs/RTUs (field devices)
# - Subscriber containers emulating SCADA/HMI systems
# - Optional bridge container for DMZ-enterprise flow testing
#
# Networks:
#   ot_net    - OT network (field devices, publishers)
#   dmz_net   - Industrial DMZ (broker, bridge, kraken)
#   it_net    - Enterprise/IT network (for bridge lateral movement testing)
#
# Security Profiles:
#   Set SECURITY_PROFILE environment variable to: insecure, partial, or hardened
#   Default: insecure (for maximum vulnerability testing)
#
# Usage:
#   SECURITY_PROFILE=insecure docker compose up -d
#   SECURITY_PROFILE=hardened docker compose up -d

services:
  # =============================================================================
  # Bootstrap: Generates certificates and password file
  # =============================================================================
  certs:
    image: eclipse-mosquitto:2.0
    container_name: scenario-a-certs
    volumes:
      - ./certs:/certs
      - ./profiles/common:/common
      - ./scripts:/scripts
    command:
      - /bin/sh
      - -c
      - |
        # Install openssl for certificate generation
        apk add --no-cache openssl > /dev/null 2>&1

        # Generate certificates
        /bin/sh /scripts/generate-certs.sh

        # Generate password file if it doesn't have hashed passwords
        if ! grep -q '$$' /common/passwd 2>/dev/null; then
          echo "Generating hashed password file..."
          rm -f /common/passwd
          mosquitto_passwd -b -c /common/passwd admin admin123
          mosquitto_passwd -b /common/passwd scada scada123
          mosquitto_passwd -b /common/passwd plc plc123
          mosquitto_passwd -b /common/passwd rtu rtu123
          mosquitto_passwd -b /common/passwd operator operator
          mosquitto_passwd -b /common/passwd guest guest
          echo "Password file generated."
        else
          echo "Password file already contains hashed passwords."
        fi

        # Fix permissions so mosquitto user (UID 1883) can read files
        chmod 644 /common/passwd 2>/dev/null || true
        chmod 644 /certs/*.crt 2>/dev/null || true
        chmod 644 /certs/*.key 2>/dev/null || true
    networks:
      - dmz_net

  # =============================================================================
  # MQTT Broker (Mosquitto) - Industrial DMZ
  # Represents the central MQTT broker at level 3.5
  # =============================================================================
  broker:
    image: eclipse-mosquitto:2.0
    container_name: scenario-a-broker
    hostname: mqtt-broker
    depends_on:
      certs:
        condition: service_completed_successfully
    ports:
      - "1883:1883"   # MQTT (plaintext - for testing anonymous access)
      - "8883:8883"   # MQTTS (TLS)
      - "8884:8884"   # MQTTS with client certificates (mTLS)
    volumes:
      - ./profiles/${SECURITY_PROFILE:-insecure}/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - ./profiles/${SECURITY_PROFILE:-insecure}/acl.conf:/mosquitto/config/acl.conf:ro
      - ./profiles/common/passwd:/mosquitto/config/passwd:ro
      - ./certs:/mosquitto/certs:ro
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log
    entrypoint: ["/usr/sbin/mosquitto", "-c", "/mosquitto/config/mosquitto.conf"]
    networks:
      dmz_net:
        ipv4_address: 172.20.0.10
      ot_net:
        ipv4_address: 172.21.0.10
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 1883 || nc -z localhost 8883 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s
    restart: unless-stopped

  # =============================================================================
  # PLC/RTU Simulator - Publisher (Field Device)
  # Publishes telemetry data to the broker
  # =============================================================================
  plc-publisher:
    image: eclipse-mosquitto:2.0
    container_name: scenario-a-plc
    hostname: plc-01
    depends_on:
      broker:
        condition: service_healthy
    volumes:
      - ./certs:/certs:ro
      - ./scripts:/scripts:ro
    entrypoint: ["/bin/sh", "/scripts/plc-publisher.sh"]
    environment:
      - MQTT_BROKER=mqtt-broker
      - MQTT_PORT=8883
      - CLIENT_ID=plc-01
      - DEVICE_TYPE=plc
    networks:
      ot_net:
        ipv4_address: 172.21.0.20
    restart: unless-stopped

  # =============================================================================
  # RTU Simulator - Publisher (Field Device)
  # Publishes sensor data to the broker
  # =============================================================================
  rtu-publisher:
    image: eclipse-mosquitto:2.0
    container_name: scenario-a-rtu
    hostname: rtu-01
    depends_on:
      broker:
        condition: service_healthy
    volumes:
      - ./certs:/certs:ro
      - ./scripts:/scripts:ro
    entrypoint: ["/bin/sh", "/scripts/rtu-publisher.sh"]
    environment:
      - MQTT_BROKER=mqtt-broker
      - MQTT_PORT=8883
      - CLIENT_ID=rtu-01
      - DEVICE_TYPE=rtu
    networks:
      ot_net:
        ipv4_address: 172.21.0.21
    restart: unless-stopped

  # =============================================================================
  # SCADA/HMI Simulator - Subscriber (Control Room)
  # Subscribes to telemetry and publishes commands
  # =============================================================================
  scada-subscriber:
    image: eclipse-mosquitto:2.0
    container_name: scenario-a-scada
    hostname: scada-01
    depends_on:
      broker:
        condition: service_healthy
    volumes:
      - ./certs:/certs:ro
      - ./scripts:/scripts:ro
    entrypoint: ["/bin/sh", "/scripts/scada-subscriber.sh"]
    environment:
      - MQTT_BROKER=mqtt-broker
      - MQTT_PORT=8883
      - CLIENT_ID=scada-01
    networks:
      dmz_net:
        ipv4_address: 172.20.0.20
    restart: unless-stopped

  # =============================================================================
  # MQTT Bridge - DMZ to Enterprise (for L-1 lateral movement testing)
  # =============================================================================
  bridge:
    image: eclipse-mosquitto:2.0
    container_name: scenario-a-bridge
    hostname: mqtt-bridge
    depends_on:
      broker:
        condition: service_healthy
    volumes:
      - ./profiles/common/bridge.conf:/mosquitto/config/mosquitto.conf:ro
      - ./certs:/mosquitto/certs:ro
    networks:
      dmz_net:
        ipv4_address: 172.20.0.30
      it_net:
        ipv4_address: 172.22.0.30
    profiles:
      - bridge
    restart: unless-stopped

  # =============================================================================
  # Seed Container - Initializes retained messages and topic structure
  # =============================================================================
  seeder:
    image: eclipse-mosquitto:2.0
    container_name: scenario-a-seeder
    depends_on:
      broker:
        condition: service_healthy
    volumes:
      - ./certs:/certs:ro
      - ./scripts:/scripts:ro
    entrypoint: ["/bin/sh", "/scripts/seed-topics.sh"]
    environment:
      - MQTT_BROKER=mqtt-broker
      - MQTT_PORT=8883
      - MQTT_USER=admin
      - MQTT_PASS=admin123
      - MQTT_TLS=true
    networks:
      dmz_net:
        ipv4_address: 172.20.0.99
    restart: "no"

  # =============================================================================
  # Kraken Security Scanner
  # =============================================================================
  kraken:
    container_name: scenario-a-kraken
    build:
      context: ../../
      dockerfile: deploy/build/Dockerfile.alpine.kraken
    command: [
        "-campaign", "/scenario/campaign.yaml",
        "-out", "/results",
        "-cidrs", "172.20.0.0/24"
    ]
    # entrypoint: ["/bin/sh"]
    # tty: true
    # stdin_open: true
    depends_on:
      broker:
        condition: service_healthy
    volumes:
      - ./results:/results
      - ./:/scenario:ro
      - ./certs:/certs:ro
    cap_add:
        - NET_RAW
        - NET_ADMIN
    networks:
      dmz_net:
        ipv4_address: 172.20.0.100
    profiles:
      - tools

  # =============================================================================
  # Network Capture (tcpdump) - for packet analysis
  # =============================================================================
  capture:
    image: alpine:3.19
    container_name: scenario-a-capture
    depends_on:
      broker:
        condition: service_healthy
    volumes:
      - ./captures:/captures
    entrypoint: ["/bin/sh", "-c", "apk add --no-cache tcpdump && echo 'Capture ready. Use: docker exec scenario-a-capture tcpdump -i any -w /captures/mqtt.pcap port 1883 or port 8883' && tail -f /dev/null"]
    cap_add:
      - NET_ADMIN
      - NET_RAW
    network_mode: host
    profiles:
      - tools

networks:
  # OT Network - Field devices (Level 0/1/2)
  ot_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/24
          gateway: 172.21.0.1

  # DMZ Network - Industrial DMZ (Level 3.5)
  dmz_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
          gateway: 172.20.0.1

  # IT Network - Enterprise (Level 4/5) - for bridge testing
  it_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.22.0.0/24
          gateway: 172.22.0.1

volumes:
  mosquitto_data:
  mosquitto_log:
