# NOTE: Attack Tree for Scenario A (MQTT Threat Model)
# Maps Kraken findings to high-level adversarial objectives.
# IMPORTANT: Finding IDs must match those produced by the modules in campaign.yaml.

# =============================================================================
# S-1 Unauthorized Command Publication (STRIDE: Spoofing, Tampering)
# Impact: Potential manipulation of physical OT processes.
# =============================================================================
- name: "S-1: UNAUTHORIZED COMMAND PUBLICATION"
  type: OR
  children:
    - name: "BYPASS AUTHENTICATION"
      type: OR
      children:
        - name: "ANONYMOUS ACCESS ENABLED"
          type: LEAF
          finding_ids: ["MQTT-ANON", "MQTT-PUBSUB-ANON"]
          finding_mode: any

        - name: "WEAK/DEFAULT CREDENTIALS"
          type: LEAF
          finding_ids: ["MQTT-VALID-CREDS", "DEFAULT-CREDENTIALS"]
          finding_mode: any

    - name: "ACL PERMITS UNAUTHORIZED PUBLISH"
      type: LEAF
      finding_ids: ["MQTT-ACL-PUB"]
      finding_mode: any

# =============================================================================
# T-1 Telemetry Tampering / Replay (STRIDE: Tampering, Repudiation)
# Impact: Incorrect control logic or state representation.
# =============================================================================
- name: "T-1: TELEMETRY TAMPERING OR REPLAY"
  type: AND
  children:
    - name: "OBTAIN VALID SESSION"
      type: OR
      children:
        - name: "ANONYMOUS CONNECTION"
          type: LEAF
          finding_ids: ["MQTT-ANON"]
          finding_mode: any

        - name: "CREDENTIAL COMPROMISE"
          type: LEAF
          finding_ids: ["MQTT-VALID-CREDS", "DEFAULT-CREDENTIALS"]
          finding_mode: any

    - name: "PUBLISH ACCESS TO TELEMETRY TOPICS"
      type: LEAF
      finding_ids: ["MQTT-ACL-PUB", "MQTT-PUBSUB-ANON"]
      finding_mode: any

# =============================================================================
# T-2 Abuse of Retained Messages (STRIDE: Tampering)
# Impact: Persistent incorrect state upon reconnection.
# =============================================================================
- name: "T-2: ABUSE OF RETAINED MESSAGES"
  type: AND
  children:
    - name: "OBTAIN PUBLISH ACCESS"
      type: OR
      children:
        - name: "ANONYMOUS PUBLISH"
          type: LEAF
          finding_ids: ["MQTT-PUBSUB-ANON"]
          finding_mode: any

        - name: "AUTHENTICATED PUBLISH"
          type: LEAF
          finding_ids: ["MQTT-ACL-PUB"]
          finding_mode: any

    - name: "RETAINED MESSAGES ENABLED"
      type: LEAF
      finding_ids: ["mqtt-conformance-test-mqtt-3.3.1-6"]
      finding_mode: any

# =============================================================================
# I-1 Unauthorized Subscription (STRIDE: Information Disclosure)
# Impact: Data leakage and reconnaissance of OT environment.
# =============================================================================
- name: "I-1: UNAUTHORIZED SUBSCRIPTION"
  type: OR
  children:
    - name: "ANONYMOUS SUBSCRIPTION"
      type: LEAF
      finding_ids: ["MQTT-ANON", "MQTT-PUBSUB-ANON"]
      finding_mode: any

    - name: "ACL PERMITS WILDCARD SUBSCRIPTION"
      type: LEAF
      finding_ids: ["MQTT-ACL-SUB"]
      finding_mode: any

# =============================================================================
# I-2 Metadata Leakage via $SYS (STRIDE: Information Disclosure)
# Impact: Disclosure of broker version, capacity, and client stats.
# =============================================================================
- name: "I-2: METADATA LEAKAGE VIA $SYS"
  type: AND
  children:
    - name: "OBTAIN BROKER ACCESS"
      type: OR
      children:
        - name: "ANONYMOUS ACCESS"
          type: LEAF
          finding_ids: ["MQTT-ANON"]
          finding_mode: any

        - name: "ANY VALID CREDENTIALS"
          type: LEAF
          finding_ids: ["MQTT-VALID-CREDS", "DEFAULT-CREDENTIALS"]
          finding_mode: any

    - name: "$SYS TOPICS ACCESSIBLE"
      type: LEAF
      finding_ids: ["mqtt-sys-disclosure"]
      finding_mode: any

# =============================================================================
# D-1 Denial of Service on Broker (STRIDE: Denial of Service)
# Impact: Loss of connectivity between field devices and control systems.
# =============================================================================
- name: "D-1: DENIAL OF SERVICE ON BROKER"
  type: OR
  children:
    - name: "RESOURCE EXHAUSTION"
      type: AND
      children:
        - name: "UNAUTHENTICATED CONNECTIONS ALLOWED"
          type: LEAF
          finding_ids: ["MQTT-ANON"]
          finding_mode: any

        - name: "NO RATE LIMITING OBSERVED"
          type: LEAF
          finding_ids: ["mqtt-conformance-test-mqtt-3.1.4-5"]
          finding_mode: any

# =============================================================================
# E-1 Session Hijack via Weak TLS (STRIDE: Elevation of Privilege)
# Impact: Interception of credentials and control commands.
# =============================================================================
- name: "E-1: SESSION HIJACK VIA WEAK TLS"
  type: OR
  children:
    - name: "WEAK TLS VERSION SUPPORTED"
      type: LEAF
      finding_ids: ["TLS-SUPPORT-OVERVIEW"]
      finding_mode: any

    - name: "CERTIFICATE ISSUES"
      type: OR
      children:
        - name: "SELF-SIGNED OR EXPIRED"
          type: LEAF
          finding_ids: ["CERT-SELFSIGNED", "CERT-EXPIRED", "CERT-EXPIRING"]
          finding_mode: any

        - name: "WEAK CRYPTOGRAPHY"
          type: LEAF
          finding_ids: ["CERT-SHA1", "CERT-WEAKKEY"]
          finding_mode: any

        - name: "HOSTNAME/IDENTITY MISMATCH"
          type: LEAF
          finding_ids: ["CERT-HOSTNAME", "CERT-NOSAN"]
          finding_mode: any

        - name: "IMPROPER KEY USAGE"
          type: LEAF
          finding_ids: ["CERT-NO-SERVER-AUTH"]
          finding_mode: any

    - name: "PLAINTEXT COMMUNICATION ALLOWED"
      type: LEAF
      finding_ids: ["MQTT-ANON"] # If we can connect to 1883
      finding_mode: any

# =============================================================================
# R-1 Non-Repudiable Actions (STRIDE: Repudiation)
# Impact: Poor auditability; hindered incident response.
# =============================================================================
- name: "R-1: NON-REPUDIABLE ACTIONS"
  type: OR
  children:
    - name: "SHARED OR DEFAULT CREDENTIALS IN USE"
      type: LEAF
      finding_ids: ["DEFAULT-CREDENTIALS", "MQTT-VALID-CREDS"]
      finding_mode: any

    - name: "ANONYMOUS ACCESS PREVENTS ATTRIBUTION"
      type: LEAF
      finding_ids: ["MQTT-ANON"]
      finding_mode: any

# =============================================================================
# L-1 Lateral Movement via MQTT Bridge (STRIDE: Lateral Movement)
# Impact: Unauthorized access to control network from DMZ/enterprise.
# =============================================================================
- name: "L-1: LATERAL MOVEMENT VIA MQTT BRIDGE"
  type: AND
  children:
    - name: "BRIDGE ACCESS OBTAINED"
      type: OR
      children:
        - name: "BRIDGE USES WEAK CREDENTIALS"
          type: LEAF
          finding_ids: ["MQTT-VALID-CREDS", "DEFAULT-CREDENTIALS"]
          finding_mode: any

        - name: "BRIDGE ALLOWS ANONYMOUS"
          type: LEAF
          finding_ids: ["MQTT-ANON"]
          finding_mode: any

    - name: "CROSS-BOUNDARY TOPIC ACCESS"
      type: LEAF
      finding_ids: ["MQTT-ACL-SUB", "MQTT-ACL-PUB"]
      finding_mode: any
