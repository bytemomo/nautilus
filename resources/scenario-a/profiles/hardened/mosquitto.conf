# HARDENED PROFILE - Mosquitto Configuration
#
# This profile implements all security best practices.
# Kraken should find NO vulnerabilities when scanning this configuration.
#
# Security measures:
# - No anonymous access on any listener
# - No plaintext MQTT (port 1883 disabled)
# - TLS 1.3 enforced
# - mTLS required (client certificates mandatory)
# - Strict ACLs with principle of least privilege
# - $SYS topics restricted to admin only
# - Strong cipher suites only
#
# Expected Kraken findings: NONE (clean scan)

# =============================================================================
# Global Settings
# =============================================================================
persistence true
persistence_location /mosquitto/data/
log_dest stdout
log_type error
log_type warning
log_type notice

# Strict ACL enforcement
acl_file /mosquitto/config/acl.conf

# Password file (backup auth, mTLS is primary)
password_file /mosquitto/config/passwd

# Connection limits for DoS protection
max_connections 100
max_inflight_messages 20
max_queued_messages 1000

# =============================================================================
# NO PLAINTEXT LISTENER
# Port 1883 is intentionally not configured
# =============================================================================

# =============================================================================
# Listener 1: TLS MQTT (Port 8883)
# SECURE: TLS 1.3, auth required, but no client certs (password auth)
# This is for clients that cannot do mTLS
# =============================================================================
listener 8883
protocol mqtt
allow_anonymous false

# TLS Configuration - Strong settings
cafile /mosquitto/certs/ca.crt
certfile /mosquitto/certs/server.crt
keyfile /mosquitto/certs/server.key

# Enforce TLS 1.3 only
tls_version tlsv1.3

# Strong ciphers only (TLS 1.3 ciphersuites)
ciphers TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256

# =============================================================================
# Listener 2: mTLS MQTT (Port 8884)
# SECURE: Full mTLS with client certificate required
# =============================================================================
listener 8884
protocol mqtt
allow_anonymous false

# TLS Configuration
cafile /mosquitto/certs/ca.crt
certfile /mosquitto/certs/server.crt
keyfile /mosquitto/certs/server.key

# Require client certificates (mTLS)
require_certificate true
use_identity_as_username true

# Enforce TLS 1.3 only
tls_version tlsv1.3

# Strong ciphers
ciphers TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256

# =============================================================================
# $SYS Topic Restriction
# Reduce exposure of system information
# =============================================================================
sys_interval 0
# Setting to 0 disables $SYS updates (no information disclosure)
