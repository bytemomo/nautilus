# Kraken Campaign for Scenario A - MQTT Threat Model
# Evaluates the security posture of the industrial MQTT infrastructure.
# Tests authentication, authorization, TLS configuration, and protocol conformance.

id: scenario-a-mqtt
type: network

policy:
  safety:
    allow_aggressive: false
    require_max_duration: true

  runner:
    max_parallel_targets: 4
    defaults:
      connection_timeout: 10s
      max_reconnects: 3

scanners:
  - type: nmap
    nmap:
      # Target MQTT ports: 1883 (plaintext), 8883 (TLS), 8884 (mTLS)
      ports: ["1883", "8883", "8884"]
      open_only: true
      timing: T3
      skip_host_discovery: false
      service_detect:
        enabled: true
        version: ALL

attack_trees_def_path: /scenario/attack-tree.yaml

conduit_templates:
  - name: tcp
    kind: stream
    stack:
      - name: tcp

  - name: tls
    kind: stream
    required_tags: ["supports:tls"]
    stack:
      - name: tcp
      - name: tls
        params:
          skip_verify: true

tasks:
  # TLS Security Assessment (Threat E-1: Session hijacking)
  - id: tls-version-check
    type: lib
    required_tags: ["supports:tls", "protocol:mqtt"]
    max_duration: 30s
    exec:
      abi:
        api: v1
        library_path: /modules/kraken/abi/tls_version_check/build/tls_version_check
        symbol: kraken_run
      params:
        min_version: "1.2"
        max_version: "1.3"

  - id: cert-inspect
    type: lib
    required_tags: ["supports:tls", "protocol:mqtt"]
    max_duration: 30s
    exec:
      abi:
        api: v1
        library_path: /modules/kraken/abi/cert_inspect/target/release/libcert_inspect
        symbol: kraken_run
      params:
        warn_days: 30
        min_rsa_bits: 2048
        allow_sha1: false
        disallow_self_signed: true

  # MQTT Authentication & Authorization Testing (Threats S-1, I-1)
  - id: mqtt-auth-check
    type: lib
    required_tags: ["protocol:mqtt"]
    max_duration: 60s
    exec:
      conduit_templates: [tcp, tls]
      abi:
        api: v2
        library_path: /modules/kraken/abi/mqtt_auth_check/build/mqtt_auth_check
        symbol: kraken_run_v2

  - id: mqtt-acl-probe
    type: lib
    required_tags: ["protocol:mqtt"]
    max_duration: 120s
    exec:
      conduit_templates: [tcp, tls]
      abi:
        api: v2
        library_path: /modules/kraken/abi/mqtt_acl_probe/build/mqtt_acl_probe
        symbol: kraken_run_v2
      params:
        credentials_file: /scenario/profiles/common/test-credentials.txt

  - id: mqtt-dict-attack
    type: native
    required_tags: ["protocol:mqtt"]
    max_duration: 180s
    exec:
      conduit_templates: [tcp, tls]
      params:
        credentials:
          - "admin:admin"
          - "admin:admin123"
          - "admin:password"
          - "scada:scada"
          - "scada:scada123"
          - "operator:operator"
          - "guest:guest"
          - "test:test"
          - "mqtt:mqtt"
          - "root:root"

  # Information Disclosure Assessment (Threat I-2: $SYS leakage)
  - id: mqtt-sys-disclosure
    type: lib
    required_tags: ["protocol:mqtt"]
    max_duration: 30s
    exec:
      abi:
        api: v1
        library_path: /modules/kraken/abi/mqtt_sys_disclosure/build/mqtt_sys_disclosure
        symbol: kraken_run
      params:
        sys_prefix: "$SYS"

  # Protocol Conformance & Robustness (Threats T-1, D-1)
  - id: mqtt-conformance-test
    type: native
    required_tags: ["protocol:mqtt"]
    max_duration: 120s
    exec:
      conduit_templates: [tcp, tls]
